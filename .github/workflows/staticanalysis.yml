name: Static Analysis Pylint
on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

# Follow the least privilege security principle for the GITHUB TOKEN
permissions:
    contents: read

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                fetch-depth: 0  # Shallow clones should be disabled for better analysis
            
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                python-version: "3.9"
            
            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
                pip install pylint coverage
            
            - name: Set PYTHONPATH so pylint can find Django project
              run: echo "PYTHONPATH=${GITHUB_WORKSPACE}" >> $GITHUB_ENV
            
            - name: Run/execute pylint on tracked Python files
              run: |
                pylint $(git ls-files '*.py') || true
            
            - name: Run Django tests with coverage
              run: |
                coverage run --source='library_web' --omit='*/tests.py,*/migrations/*,*/__init__.py' manage.py test library_web
            
            - name: Generate coverage reports
              run: |
                coverage xml -o coverage.xml
                coverage report -m
            
            - name: Display coverage summary
              run: |
                echo "Coverage Report:"
                coverage report
            
            - name: Upload coverage artifact
              uses: actions/upload-artifact@v3
              with:
                name: coverage-report
                path: |
                  coverage.xml
                  htmlcov/
            
            - name: SonarCloud Scan
              uses: SonarSource/sonarcloud-scan-action@v3.0.0
              with:
                args: >
                  -Dsonar.projectKey=Vishal-v-17_Devops_Project
                  -Dsonar.organization=vishal-v-17
                  -Dsonar.sources=library_web
                  -Dsonar.tests=library_web
                  -Dsonar.test.inclusions=**/*tests.py,**/test_*.py
                  -Dsonar.python.version=3.9
                  -Dsonar.python.coverage.reportPaths=coverage.xml
                  -Dsonar.exclusions=staticfiles/**,**/migrations/**,**/__pycache__/**,**/tests.py,**/test_*.py
                  -Dsonar.coverage.exclusions=**/tests.py,**/test_*.py,**/migrations/**,**/__init__.py
                  -Dsonar.generatedSources=staticfiles/admin/**
                  -Dsonar.cpd.exclusions=library_web/tests.py,templates/**,migrations/**
                  -Dsonar.python.coverage.reportPaths=coverage.xml
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                
            - name: Run Django tests with coverage
              run: |
                coverage run --source='library_web' --omit='*/tests.py,*/migrations/*,*/__init__.py' manage.py test library_web
            
            - name: Generate coverage reports
              run: |
                coverage xml -o coverage.xml
                coverage report -m