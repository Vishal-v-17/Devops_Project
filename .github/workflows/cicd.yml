name: CI + CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:

permissions:
  actions: read
  contents: read

jobs:
  # ===========================================================
  # 1️⃣ CI JOB — RUN TESTS, COVERAGE, SONARCLOUD, PACKAGE APP
  # ===========================================================
  ci:
    runs-on: ubuntu-latest
    
    env:
      GITHUB_ACTIONS: true
      PYTEST_CURRENT_TEST: true

      DJANGO_SETTINGS_MODULE: Library_project.settings
      DJANGO_SECRET_KEY: dummy-secret-for-ci
      AWS_ACCESS_KEY_ID: test_access_key
      AWS_SECRET_ACCESS_KEY: test_secret_key
      AWS_DEFAULT_REGION: us-east-1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-django

      - name: Run migrations
        run: python manage.py migrate --noinput

      - name: Run tests with coverage
        run: |
          pytest --cov=library_web --cov-report=xml:coverage.xml --cov-report=term-missing -v

      - name: Check coverage file exists
        run: |
          if [ ! -f coverage.xml ]; then
            echo "❌ coverage.xml missing!"
            exit 1
          fi
          echo "✓ coverage.xml OK"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=YourSonarProjectKey
            -Dsonar.organization=YourSonarOrg
            -Dsonar.sources=library_web
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.verbose=true
        continue-on-error: true

      - name: Build deployment package
        run: |
          zip -r app.zip . \
            -x "env/*" \
            -x "venv/*" \
            -x "**/__pycache__/*" \
            -x ".git/*" \
            -x ".github/*" \
            -x "*.pytest_cache/*" \
            -x "*.coverage" \
            -x "db.sqlite3"

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-zip
          path: ./app.zip


  # ===========================================================
  # 2️⃣ CD JOB — DEPLOY TO AWS EB (elibrary / dev-env)
  # ===========================================================
  deploy:
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-zip
          path: .

      - name: Unzip
        run: unzip -o app.zip -d deploy

      - name: Setup Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install AWS CLI + EB CLI
        run: |
          python -m pip install --upgrade pip
          pip install awscli awsebcli

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Deploy to Elastic Beanstalk
        id: deploy
        working-directory: ./deploy
        run: |
          set -e
          
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          S3_BUCKET="elasticbeanstalk-us-east-1-${ACCOUNT_ID}"

          APP_NAME="elibrary"
          ENV_NAME="dev-env"

          VERSION_LABEL="v-${{ github.run_number }}-$(echo ${{ github.sha }} | cut -c1-7)"

          echo "Creating S3 deployment package..."
          zip -r ../deploy.zip .

          echo "Uploading to S3..."
          aws s3 cp ../deploy.zip s3://${S3_BUCKET}/${APP_NAME}/${VERSION_LABEL}.zip

          echo "Creating application version..."
          aws elasticbeanstalk create-application-version \
            --application-name $APP_NAME \
            --version-label $VERSION_LABEL \
            --source-bundle S3Bucket=$S3_BUCKET,S3Key=${APP_NAME}/${VERSION_LABEL}.zip

          echo "Deploying to environment..."
          aws elasticbeanstalk update-environment \
            --application-name $APP_NAME \
            --environment-name $ENV_NAME \
            --version-label $VERSION_LABEL

          echo "Waiting for deployment..."
          aws elasticbeanstalk wait environment-updated \
            --application-name $APP_NAME \
            --environment-name $ENV_NAME

          ENV_URL=$(aws elasticbeanstalk describe-environments \
            --application-name $APP_NAME \
            --environment-names $ENV_NAME \
            --query "Environments[0].CNAME" \
            --output text)

          echo "url=http://${ENV_URL}" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "### Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** dev-env" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
