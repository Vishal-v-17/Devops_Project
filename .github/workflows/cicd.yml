name: CI + CD Pipeline

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

permissions:
    contents: read

jobs:
    # ==============================
    #  CI JOB (LINT + TEST + SONARCLOUD)
    # ==============================
    ci:        # <<< CHANGED from "lint" → "ci"
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                fetch-depth: 0  # Required for SonarCloud
            
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                python-version: "3.9"
            
            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
                pip install pylint coverage pytest pytest-django pytest-cov
            
            - name: Set PYTHONPATH so pylint can find Django project
              run: echo "PYTHONPATH=${GITHUB_WORKSPACE}" >> $GITHUB_ENV
            
            - name: Run Pylint
              run: |
                pylint $(git ls-files '*.py')
            
            - name: Run Django tests with coverage
              run: |
                coverage run --source='library_web' --omit='*/tests.py,*/migrations/*,*/__init__.py' manage.py test library_web
            
            - name: Generate coverage.xml for SonarCloud
              run: |
                coverage xml -o coverage.xml
                coverage report
            
            - name: SonarCloud Scan
              uses: SonarSource/sonarqube-scan-action@v5.0.0
              continue-on-error: true
              with:
                args: >
                  -Dsonar.projectKey=Vishal-v-17_Devops_Project
                  -Dsonar.organization=vishal-v-17
                  -Dsonar.sources=library_web
                  -Dsonar.tests=library_web
                  -Dsonar.test.inclusions=**/*tests.py,**/test_*.py
                  -Dsonar.python.version=3.9
                  -Dsonar.python.coverage.reportPaths=coverage.xml
                  -Dsonar.exclusions=staticfiles/**,**/migrations/**,**/__pycache__/**,**/tests.py,**/test_*.py
                  -Dsonar.coverage.exclusions=**/tests.py,**/test_*.py,**/migrations/**,**/__init__.py
                  -Dsonar.generatedSources=staticfiles/admin/**
                  -Dsonar.cpd.exclusions=library_web/tests.py,templates/**,migrations/**
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # ==============================
            # Build deployable ZIP package
            # ==============================
            - name: Build deployment package
              run: |
                zip -r app.zip . \
                  -x "env/*" \
                  -x "venv/*" \
                  -x "**/__pycache__/*" \
                  -x ".git/*" \
                  -x ".github/*" \
                  -x "*.pytest_cache/*" \
                  -x "*.coverage" \
                  -x "db.sqlite3"

            - name: Upload deployment artifact
              uses: actions/upload-artifact@v4
              with:
                name: deploy-zip
                path: ./app.zip


    # ===========================================================
    #  CD JOB — DEPLOY TO AWS EB (elibrary / dev-env)
    # ===========================================================
    deploy:
        needs: ci          # <<< now correct
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                name: deploy-zip
                path: .

            - name: Unzip
              run: unzip -o app.zip -d deploy

            - name: Setup Python 3.9
              uses: actions/setup-python@v5
              with:
                python-version: "3.9"

            - name: Install AWS CLI + EB CLI
              run: |
                python -m pip install --upgrade pip
                pip install awscli awsebcli

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
                aws-region: us-east-1

            - name: Deploy to Elastic Beanstalk
              id: deploy
              working-directory: ./deploy
              run: |
                set -e
                
                ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
                S3_BUCKET="elasticbeanstalk-us-east-1-${ACCOUNT_ID}"

                APP_NAME="elibrary"
                ENV_NAME="dev-env"

                VERSION_LABEL="v-${{ github.run_number }}-$(echo ${{ github.sha }} | cut -c1-7)"

                echo "Creating S3 deployment package..."
                zip -r ../deploy.zip .

                echo "Uploading to S3..."
                aws s3 cp ../deploy.zip s3://${S3_BUCKET}/${APP_NAME}/${VERSION_LABEL}.zip

                echo "Creating application version..."
                aws elasticbeanstalk create-application-version \
                  --application-name $APP_NAME \
                  --version-label $VERSION_LABEL \
                  --source-bundle S3Bucket=$S3_BUCKET,S3Key=${APP_NAME}/${VERSION_LABEL}.zip

                echo "Deploying to environment..."
                aws elasticbeanstalk update-environment \
                  --application-name $APP_NAME \
                  --environment-name $ENV_NAME \
                  --version-label $VERSION_LABEL

                echo "Waiting for deployment..."
                aws elasticbeanstalk wait environment-updated \
                  --application-name $APP_NAME \
                  --environment-name $ENV_NAME

                ENV_URL=$(aws elasticbeanstalk describe-environments \
                  --application-name $APP_NAME \
                  --environment-names $ENV_NAME \
                  --query "Environments[0].CNAME" \
                  --output text)

                echo "url=http://${ENV_URL}" >> $GITHUB_OUTPUT

            - name: Deployment Summary
              run: |
                echo "### Deployment Complete" >> $GITHUB_STEP_SUMMARY
                echo "**Environment:** dev-env" >> $GITHUB_STEP_SUMMARY
                echo "**URL:** http://${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
